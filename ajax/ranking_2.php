<?phpheader('Content-Type: text/html; charset=utf-8');require_once('../objetos/conexao.php');require_once('../objetos/sessao.php');$sOrigem = addslashes($_GET["origem"]);switch ($sOrigem){	case "listaUltimoVenc": listaUltimoVenc(); break;		case "rankingVitorias": rankingVitorias(); break;}function listaUltimoVenc(){	$oConexao = new Conexao();	$sJogoID = addslashes($_GET["jogoID"]);	$iPosicao = 1;		$sSQL = "SELECT ".				"U.Nome, ".				"P.Data, ".				"Participante.Fichas FichaVenc, ".				"L.descricao Local,".				"( ".					"(".						 "P.FichasBuyIn  ".						"* ".						"( ".							"SELECT  ".															"COUNT(ID) ".														"FROM ".								"Participante ".							"WHERE ".								"IDPartida=P.ID ".						")".					") +  ".					"(".						"P.FichasReBuy  ".						"* ".						"( ".							"SELECT  ".															"sum(ReBuys) ".														"FROM ".								"Participante ".							"WHERE ".								"IDPartida=P.ID ".						")".					") ".				") TotalFichas, ".				"(	".		 							"P.ValorBuyIn * ".					"( ".						"SELECT ".							"COUNT(ID) ".												"FROM ".							"Participante ".						"WHERE ".							"IDPartida=P.ID ".					") + ".					"( ".						"SELECT ".							"SUM(Rebuys * P.ValorRebuy) ".													"FROM ".							"Participante ".						"WHERE ".							"IDPartida=P.ID ".					") 	".				") TotalValor ".			"FROM ".				"Partida P ".				"INNER JOIN Participante ON (Participante.IDPartida=P.ID) ".				"INNER JOIN Usuario U ON (U.ID = Participante.IDUsuario) ".				"INNER JOIN Local L ON (L.ID = P.IDLocal) ".			"WHERE ".				"Participante.Vencedor=1 AND ".				"P.ID=(select max(ID) from Partida where Data < CURRENT_DATE()) ".			"ORDER BY FichaVenc DESC;";				$rsLista = $oConexao->sql($sSQL);		$sRetorno = "";	while($lsLista = mysql_fetch_array($rsLista))	{		$sRetorno .= "<tr>".						"<td nowrap>". getClassificacao($iPosicao) ."</td>".						"<td nowrap><label>" . $lsLista[Nome] . "</label></td>".						"<td nowrap><label>R$ ". number_format(($lsLista[TotalValor] * $lsLista[FichaVenc])  / $lsLista[TotalFichas], 2, '.', '') ."</label></td>".						"<td nowrap><label>". $lsLista[Local] ."</label></td>".						"<td nowrap><label>". date('d/m/Y', strtotime($lsLista[Data])) ."</label></td>".					"</tr>";							$iPosicao = $iPosicao + 1;	}		if ($sRetorno != "")	{		$sRetorno = "<table>".												"<tr class='cabecalhoRelatorio'>".							"<td width='16px'></td>".							"<td nowrap style='width:150px;'><label><b>Nome Vencedor</b></label></td>".							"<td nowrap style='width:150px;'><label><b>Valor recebido</b></label></td>".							"<td nowrap style='width:150px;'><label><b>Local</b></label></td>".							"<td nowrap style='width:150px;'><label><b>Data</b></label></td>".						"<tr>".						$sRetorno . 					"</table>";	}	else	{		$sRetorno = "<label>Nenhuma Partida Cadastrada.&nbsp;</label>";	}	$oConexao->fechar();		// Retorno AJAX	echo $sRetorno;	//echo $sSQL}function rankingVitorias(){	$oConexao = new Conexao();	$iPosicao = 1;	$iSaldo = 0;		$sOrder = addslashes($_GET["order"]);		if ($sOrder = "") 	{		$sOrder = " Vitorias ";	}	$sSQL = "SELECT " .				"U.Nome, ".				"(".					"SELECT ".						"COUNT(P.ID) ".					"FROM ".						"Participante P ".						"INNER JOIN Partida P2 ON (P2.ID = P.IDPartida) ".					"WHERE ".						"P.IDUsuario = U.ID ".						"AND P.Vencedor = 1 ".						"AND P2.Data < CURRENT_DATE() ".				") Vitorias, ".				"(".					"(SELECT ".						"COUNT(P.ID) ".					"FROM ".						"Participante P ".						"INNER JOIN Partida P2 ON (P2.ID = P.IDPartida) ".					"WHERE ".						"P.IDUsuario = U.ID ".						"AND P2.Data < CURRENT_DATE() ".						"AND P.Vencedor = 1) / ".					"(SELECT ".						"COUNT(P.ID) ".					"FROM ".						"Partida P ".						"INNER JOIN Participante ON (Participante.IDPartida=P.ID) ".					"WHERE ".						"Participante.IDUsuario = U.ID ".						"AND P.Data < CURRENT_DATE() ".					")  * ".					" 100 ".				") Aproveitamento, ".				"(".					"SELECT ".						"COUNT(P.ID) ".					"FROM ".						"Participante P ".						"INNER JOIN Partida P2 ON (P2.ID = P.IDPartida) ".					"WHERE ".						"P.IDUsuario = U.ID ".						"AND P2.Data < CURRENT_DATE() ".				") Jogos, ".				"(".					"SELECT ".						"SUM(	".							"CAST(P.ValorBuyIn AS UNSIGNED) * ".							"( ".								"SELECT ".									"COUNT(ID) ".								"FROM ".									"Participante ".								"WHERE ".									"ID=Participante.ID ".							") + ".							"( ".								"(SELECT ".									"SUM(Rebuys) ".								"FROM ".									"Participante ".								"WHERE ".									"ID=Participante.ID )".								" * P.ValorRebuy ".							") 	".						")  ".					" * SUM(Participante.Fichas)  ".					" / ".					"( ".						"(".							 "SUM(CAST(P.FichasBuyIn AS UNSIGNED))  ".							"* ".							"( ".								"SELECT  ".									"COUNT(ID) ".								"FROM ".									"Participante ".								"WHERE ".									"ID=Participante.ID ".							")".						") +  ".						" SUM(".							"CAST(P.FichasReBuy AS UNSIGNED) ".							"* ".							"( ".								"SELECT  ".									"SUM(ReBuys) ".								"FROM ".									"Participante ".								"WHERE ".									"ID=Participante.ID ".							")".						") ".					") ".					"FROM ".						"Partida P ".						"INNER JOIN Participante ON (Participante.IDPartida=P.ID) ".					"WHERE ".						"Participante.Vencedor=1 AND ".						"P.Data < CURRENT_DATE() AND ".						"Participante.IDUsuario = U.ID ".				") ".				"ValorTotalGanho, ".				"(".						"SELECT ".							"SUM(P.ValorBuyIn) ".						"FROM ".							"Partida P ".							"INNER JOIN Participante ON (Participante.IDPartida=P.ID) ".						"WHERE ".							" Participante.IDUsuario = U.ID ".							" AND P.Data < CURRENT_DATE() ".				") TotalGastoBuyIn,".				"IFNULL(".						"(".							"SELECT ".								"SUM(Participante.Rebuys) ".							"FROM ".								"Participante ".								"INNER JOIN Partida P ON (Participante.IDPartida=P.ID) ".							"WHERE ".								"Participante.IDUsuario = U.ID AND ".								"P.Data < CURRENT_DATE() ".						"),0)".				" TotalRebuys, ".				"(".					"SELECT ".						"IFNULL(SUM(IFNULL(Rebuys,0) * P.ValorRebuy),0) ".					"FROM ".						"Partida P ".						"INNER JOIN Participante ON (Participante.IDPartida=P.ID) ".					"WHERE ".						"P.Data < CURRENT_DATE() AND ".						"Participante.IDUsuario = U.ID ".				") TotalGastoRebuys	".			"FROM ".				"Usuario U ".			"WHERE ".				"U.Tipo <> 'A' ".			"ORDER BY ".				"Vitorias DESC, ".				"ValorTotalGanho DESC, ".				"Jogos DESC, ".				"TotalRebuys ASC ;";			$rsLista = $oConexao->sql($sSQL);	$sRetorno = "";	while($lsLista = mysql_fetch_array($rsLista))	{				$iSaldo = ($lsLista[ValorTotalGanho]-($lsLista[TotalGastoBuyIn]+$lsLista[TotalGastoRebuys]));		if ($iSaldo < 0 )		{			$corSaldo = " style='color:red' ";		}else{			$corSaldo = " style='color:black' ";			}		$sRetorno .= "<tr>".						"<td nowrap>" . getClassificacao($iPosicao) . "</td>".						"<td nowrap align='center'><label><b>" . $iPosicao . "º</b></label></td>".						"<td nowrap><label>&nbsp;". $lsLista[Nome] ."</label></td>".						"<td nowrap align='center'><label>". $lsLista[Vitorias] ."</label></td>".						"<td nowrap align='center'><label>". number_format($lsLista[Aproveitamento], 0, ',', '') ."%</label></td>".						"<td nowrap align='center'><label>". $lsLista[Jogos] ."</label></td>".						"<td nowrap align='left'><label>R$ ". number_format($lsLista[ValorTotalGanho], 2, ',', '') ."</label></td>".						"<td nowrap align='left'><label ". $corSaldo .">R$ ". number_format($iSaldo, 2, ',', '') ."</label></td>".						"<td nowrap align='left'><label>". $lsLista[TotalRebuys] ."</label></td>".						"<td nowrap align='left'><label>R$ ". number_format($lsLista[TotalGastoRebuys], 2, ',', '') ."</label></td>".					"</tr>";							$iPosicao = $iPosicao + 1;	}		//if ($sRetorno != "")	//{		$sRetorno = "<table cellpadding='0' cellspacing='1' id='ListTable'>".						"<tr class='cabecalhoRelatorio' height='18'>".							"<td width='16px'></td>".							"<td nowrap style='width:10px;'><label><b>&nbsp;Posição</b></label></td>".							"<td nowrap style='width:150px;'><label><b>&nbsp;Nome</b></label></td>".							"<td nowrap style='width:10px;'><label title='Total de Vitórias'><b>&nbsp;Vitórias</b></label></td>".							"<td nowrap style='width:110px;'><label title='Média de Vitórias por Jogo'><b>&nbsp;Aproveitamento</b></label></td>".							"<td nowrap style='width:10px;'><label><b>&nbsp;Jogos</b></label></td>".							"<td nowrap style='width:150px;'><label><b>&nbsp;Valor Recebido (R$)</b></label></td>".							"<td nowrap style='width:85px;'><label><b>&nbsp;Saldo (R$)</b></label></td>".							"<td nowrap style='width:65px;'><label><b>&nbsp;Rebuys</b></label></td>".							"<td nowrap style='width:95px;'><label><b>&nbsp;Rebuys (R$)</b></label></td>".						"<tr>".						$sRetorno . 					"</table>";	//}	//else	//	$sRetorno = "<label>Nenhuma Partida Cadastrada.&nbsp;</label>";		$oConexao->fechar();		// Retorno AJAX	echo $sRetorno;}function getClassificacao($iPosicao){	$sIconeTrofeu = "";	switch ($iPosicao)	{		case 1 :			$sIconeTrofeu = "<img src='images/trofeu_ouro.png' title='Vencedor'>";			break;			case 2:			$sIconeTrofeu = "<img src='images/trofeu_prata.png' title='2º Lugar'>";			break;		case 3: 			$sIconeTrofeu = "<img src='images/trofeu_bronze.png' title='3º Lugar'>";			break;		case 4:			$sIconeTrofeu = "<img src='images/medalha_ouro.png' title='4ºLugar'>";			break;		case 5: 			$sIconeTrofeu = "<img src='images/medalha_prata.png' title='5º Lugar'>";			break;		case 6:			$sIconeTrofeu = "<img src='images/medalha_bronze.png' title='6º Lugar'>";			break;		default:			$sIconeTrofeu = "<img src='images/triste.png'>";			break;	}		return 	$sIconeTrofeu;}?>